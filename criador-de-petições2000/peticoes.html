<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Petições</title>
  <style>
    :root {
      --bg: #0b0c10; --panel: #0f1220; --muted: #aab1c3; --text: #e9ecf5; --brand: #6ee7ff; --accent: #7c3aed; --radius: 16px; --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, "Noto Sans";
      background: radial-gradient(1200px 800px at 10% -10%, #1a1f2b 0, transparent 60%),
                  radial-gradient(900px 600px at 110% 10%, #0f1220 0, transparent 55%), var(--bg);
      color: var(--text);
      min-height: 100vh; display: grid; grid-template-rows: auto 1fr; }
    header { max-width: 1100px; width: 100%; margin: 24px auto 8px; padding: 0 16px; }
    header h1 { margin: 0; font-size: 28px; }
    header p { margin: 6px 0 0; color: var(--muted); }
    .toolbar { max-width: 1100px; width: 100%; margin: 12px auto 0; padding: 0 16px 12px; display: grid; grid-template-columns: 1fr auto auto; gap: 12px; align-items: center; }
    .toolbar a { text-decoration: none; color: white; background: linear-gradient(135deg, var(--accent), #4f46e5); padding: 10px 14px; border-radius: 10px; font-weight: 700; }
    .filters { display: grid; grid-template-columns: 1fr 170px 170px; gap: 10px; }
    input[type="search"], select { width: 100%; background: #0c0f1a; border: 1px solid rgba(255,255,255,.09); color: var(--text); border-radius: 10px; padding: 10px 12px; }
    main { max-width: 1100px; width: 100%; margin: 0 auto 60px; padding: 0 16px; }
    .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
    .card { background: var(--panel); border: 1px solid rgba(255,255,255,.06); border-radius: var(--radius); box-shadow: var(--shadow); padding: 16px; display: grid; gap: 8px; }
    .badge { display: inline-flex; align-items: center; gap: 6px; background: rgba(110,231,255,.08); color: #c9f7ff; border: 1px solid rgba(110,231,255,.3); padding: 4px 8px; border-radius: 999px; font-size: 12px; }
    .title { font-size: 18px; font-weight: 700; margin: 0; }
    .meta { font-size: 12px; color: var(--muted); display: flex; gap: 10px; flex-wrap: wrap; }
    .desc { color: #d9def0; font-size: 14px; line-height: 1.45; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; }
    .empty { margin: 22px 0; color: var(--muted); }
    footer { max-width: 1100px; width: 100%; margin: 6px auto 24px; padding: 0 16px; color: var(--muted); font-size: 13px; }
    @media (max-width: 990px){ .grid{ grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 640px){ .grid{ grid-template-columns: 1fr;} .filters{ grid-template-columns: 1fr; } .toolbar{ grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header>
    <h1>Petições</h1>
    <p>Acompanhe as petições publicadas pela comunidade, em tempo real.</p>
  </header>

  <div class="toolbar">
    <div class="filters">
      <input id="q" type="search" placeholder="Pesquisar por título, descrição, autor ou destinatário..." />
      <select id="category">
        <option value="">Todas as categorias</option>
        <option>Geral</option><option>Educação</option><option>Saúde</option><option>Transporte</option>
        <option>Ambiente</option><option>Segurança</option><option>Tecnologia</option><option>Cultura</option>
      </select>
      <select id="order">
        <option value="recent">Mais recentes</option>
        <option value="old">Mais antigas</option>
        <option value="title">A–Z (título)</option>
      </select>
    </div>
    <a href="peticao-nova.html">+ Nova petição</a>
    <a id="share" href="#">Copiar link</a>
  </div>

  <main>
    <div id="list" class="grid"></div>
    <div id="empty" class="empty" style="display:none;">Nenhuma petição encontrada.</div>
  </main>

  <footer>
    Dica: use o campo de pesquisa e filtros para encontrar mais rápido.
  </footer>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // === CONFIG DO SEU PROJETO ===
    const firebaseConfig = {
  apiKey: "AIzaSyBmaIc7aA25g5WVP_DTGHOCEtnW1ZXuyNc",
  authDomain: "aawards.firebaseapp.com",
  databaseURL: "https://aawards-default-rtdb.firebaseio.com",
  projectId: "aawards",
  storageBucket: "aawards.firebasestorage.app",
  messagingSenderId: "839334918366",
  appId: "1:839334918366:web:81f2bbfc78fd85f046ea4f",
  measurementId: "G-Z9YLSTGHST"
};

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const col = db.collection('petitions');

    const dom = {
      list: document.getElementById('list'),
      empty: document.getElementById('empty'),
      q: document.getElementById('q'),
      category: document.getElementById('category'),
      order: document.getElementById('order'),
      share: document.getElementById('share'),
    };

    // Utilitários
    const fmtDate = ts => {
      if (!ts) return '—';
      const d = ts.toDate();
      return d.toLocaleDateString('pt-PT', { day: '2-digit', month: 'short', year: 'numeric' });
    };

    function highlight(text, query){
      if(!query) return text;
      const rx = new RegExp('(' + query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'ig');
      return text.replace(rx, '<mark>$1</mark>');
    }

    // Estado
    let allDocs = []; // mantido em memória para filtros locais

    // Real-time: carregar em ordem de data
    let unsub = null;

    function attachRealtime(orderByField = 'createdAt', dir = 'desc'){
      if (unsub) unsub();
      unsub = col.orderBy(orderByField, dir).onSnapshot(snap => {
        allDocs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        render();
        // Se chegou com hash (#docId), destaque esse item
        const hashId = location.hash.replace('#','');
        if (hashId){
          const el = document.querySelector(`[data-id="${hashId}"]`);
          if (el){ el.style.outline = '2px solid var(--brand)'; el.scrollIntoView({behavior:'smooth', block:'center'}); }
        }
      });
    }

    function render(){
      const q = dom.q.value.trim().toLowerCase();
      const cat = dom.category.value;

      let items = allDocs.slice();
      if (cat) items = items.filter(x => x.category === cat);
      if (q){
        items = items.filter(x => {
          const text = [x.title, x.body, x.author, x.target].filter(Boolean).join(' ').toLowerCase();
          return text.includes(q);
        });
      }

      dom.list.innerHTML = items.map(x => cardHTML(x, q)).join('');
      dom.empty.style.display = items.length ? 'none' : 'block';
    }

    function cardHTML(x, q){
      const title = highlight(escapeHTML(x.title || 'Sem título'), q);
      const body = highlight(escapeHTML(x.body || ''), q);
      const author = x.author ? `• Autor: ${escapeHTML(x.author)}` : '';
      const target = x.target ? `• Destinatário: ${escapeHTML(x.target)}` : '';
      const cat = x.category || 'Geral';
      const date = fmtDate(x.createdAt);
      return `
        <article class="card" data-id="${x.id}">
          <span class="badge">${cat}</span>
          <h3 class="title">${title}</h3>
          <div class="meta">${date} ${author} ${target}</div>
          <div class="desc">${body}</div>
        </article>
      `;
    }

    function escapeHTML(str){
      return (str||'').replace(/[&<>"])/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s] || s);
    }

    // Interações
    dom.q.addEventListener('input', render);
    dom.category.addEventListener('change', render);
    dom.order.addEventListener('change', () => {
      const v = dom.order.value;
      if (v === 'recent') attachRealtime('createdAt', 'desc');
      else if (v === 'old') attachRealtime('createdAt', 'asc');
      else if (v === 'title') attachRealtime('title', 'asc');
    });

    dom.share.addEventListener('click', (e) => {
      e.preventDefault();
      navigator.clipboard.writeText(location.href).then(() => {
        dom.share.textContent = 'Link copiado!';
        setTimeout(() => dom.share.textContent = 'Copiar link', 1200);
      });
    });

    // Inicia com mais recentes
    attachRealtime('createdAt', 'desc');
  </script>
</body>
</html>
