<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Feliz Anivers√°rio Prof. Isabel! üéÇ‚ú®</title>
  <style>
    :root{
      --bg1:#1b1e2b; /* fundo profundo */
      --bg2:#2b2f45; /* gradiente */
      --accent:#ff76c8; /* rosa neon */
      --accent-2:#ffd166; /* dourado */
      --glow: drop-shadow(0 0 6px rgba(255, 118, 200,.8)) drop-shadow(0 0 16px rgba(255,209,102,.5));
      --text:#f7f7fb;
    }

    *{box-sizing:border-box}
    html,body{height:100%;}
    body{
      margin:0; color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 70% -10%, #3a2e4c 0%, transparent 60%),
                  radial-gradient(800px 600px at -10% 120%, #28324a 0%, transparent 60%),
                  linear-gradient(160deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    /* Estrelas suaves ao fundo */
    .stars{
      position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index:0;
    }
    .stars i{
      position:absolute; width:2px; height:2px; background:rgba(255,255,255,.9); border-radius:50%;
      opacity:.6; animation: twinkle var(--t,6s) ease-in-out infinite;
      filter: drop-shadow(0 0 4px rgba(255,255,255,.6));
    }
    @keyframes twinkle{ 0%,100%{opacity:.2; transform:scale(.6)} 50%{opacity:1; transform:scale(1)} }

    .wrap{position:relative; z-index:1; min-height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:24px; padding:32px 16px 80px}

    h1{
      margin:0; font-weight:900; text-align:center; line-height:1.05; letter-spacing:.5px;
      font-size: clamp(32px, 5vw, 64px);
      background: conic-gradient(from 10deg, var(--accent), #fff, var(--accent-2), var(--accent));
      -webkit-background-clip:text; background-clip:text; color:transparent;
      filter: var(--glow);
    }
    .subtitle{opacity:.95; text-align:center; font-size:clamp(14px,2.2vw,18px)}

    /* Palco do bolo */
    .stage{ position:relative; width:min(560px, 92vw); aspect-ratio: 1.6/1; display:grid; place-items:end center; margin-top:8px; }
    .plate{ width:80%; height:18px; background: linear-gradient(#e9edf3, #cfd6e6); border-radius:999px; box-shadow: 0 12px 40px rgba(0,0,0,.35); }

    /* Bolo em camadas */
    .cake{ position:absolute; bottom:18px; width:62%; left:50%; transform:translateX(-50%); display:grid; place-items:center; }
    .tier{ width:100%; height:120px; background: linear-gradient(180deg, #ffd9e8 0%, #ffc0df 60%, #ffb4d9 100%); border-radius:24px 24px 14px 14px;
           box-shadow: inset 0 6px 0 rgba(255,255,255,.9), inset 0 -10px 0 #f7a5d1, 0 10px 30px rgba(0,0,0,.2);
           position:relative; }
    .tier.small{ width:66%; height:90px; margin-top:-36px; background:linear-gradient(180deg,#fff1cd 0%, #ffe19b 60%, #ffd166 100%); box-shadow: inset 0 6px 0 rgba(255,255,255,.9), inset 0 -10px 0 #f2c062, 0 10px 24px rgba(0,0,0,.18); }

    /* Cobertura pinga-pinga */
    .drip{ position:absolute; top:0; left:0; right:0; height:36px; background: repeating-linear-gradient(90deg, transparent 0 18px, rgba(0,0,0,.07) 18px 19px); opacity:.1; border-radius:24px 24px 0 0 }

    /* Velas */
    .candles{ position:absolute; top:-46px; display:flex; gap:14px; align-items:flex-end; justify-content:center; }
    .candle{ width:16px; height:44px; background: repeating-linear-gradient(90deg, #fff 0 4px, #cde 4px 8px); border-radius:6px; position:relative; cursor:pointer; transform-origin:center bottom; transition: transform .2s ease; }
    .candle:hover{ transform: translateY(-2px) scale(1.03) }
    .wick{ position:absolute; top:-6px; left:50%; width:2px; height:8px; background:#333; transform: translateX(-50%); border-radius:2px; }

    .flame{ position:absolute; top:-22px; left:50%; width:12px; height:18px; transform:translateX(-50%);
            background: radial-gradient(ellipse at center, #fff7ba 0%, #ffe27a 50%, #ff9f40 75%, rgba(255,159,64,0) 80%);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%; filter: drop-shadow(0 0 6px #ffd166) drop-shadow(0 0 16px rgba(255,209,102,.9));
            animation: flicker .12s infinite alternate; transform-origin: center bottom;
          }
    @keyframes flicker{ from{ transform: translateX(-50%) scale(1) } to{ transform: translateX(calc(-50% + 1px)) scale(1.07) } }
    .candle.out .flame{ display:none }

    /* Mensagem quando apagar as velas */
    .wish{ opacity:0; transform: translateY(10px) scale(.98); transition: all .5s ease; text-align:center; font-weight:700; font-size: clamp(18px, 2.6vw, 28px); }
    .wish.show{ opacity:1; transform: translateY(0) scale(1); filter: var(--glow); }

    /* Controles */
    .controls{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; align-items:center; margin-top:10px }
    .btn{ --shine: rgba(255,255,255,.35); appearance:none; border:none; cursor:pointer; padding:12px 16px; border-radius:14px; font-weight:700;
          background: linear-gradient(180deg, #3c2f4f, #2d2942); color:#fff; box-shadow: inset 0 1px 0 rgba(255,255,255,.2), 0 10px 20px rgba(0,0,0,.35);
          transition: transform .12s ease, box-shadow .2s ease, background .2s ease; position:relative; overflow:hidden }
    .btn:before{ content:""; position:absolute; inset:0; background: linear-gradient(120deg, transparent 35%, var(--shine), transparent 65%); transform: translateX(-120%);
                 transition: transform .6s ease; }
    .btn:hover:before{ transform: translateX(120%); }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 14px 28px rgba(0,0,0,.35); }
    .btn.primary{ background: linear-gradient(180deg, #ff7bc9, #ff52b7); }
    .btn.gold{ background: linear-gradient(180deg, #ffd978, #fcbf49); color:#3d2a00 }
    .btn.ghost{ background: transparent; border:1px solid rgba(255,255,255,.15)}
    .btn.tiny{ font-size:12px; padding:8px 10px; border-radius:10px }

    .row{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; align-items:center }
    .badge{ font-size:12px; opacity:.85; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.1) }

    /* Canvas de confeti */
    #confetti{ position:fixed; inset:0; pointer-events:none; z-index:2 }

    /* Toast simples */
    .toast{ position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background: rgba(30,30,48,.9); border:1px solid rgba(255,255,255,.12);
            padding:10px 14px; border-radius:12px; font-weight:600; opacity:0; transition: all .35s ease; z-index:3 }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(-6px) }

    /* Footer */
    footer{ position:fixed; right:12px; bottom:12px; opacity:.6; font-size:12px }

    /* Responsivo: reduz pra√ßa do bolo em ecr√£s pequenos */
    @media (max-width:420px){ .candles{ gap:10px } .candle{ transform: scale(.9) } }
  </style>
</head>
<body>
  <canvas id="confetti"></canvas>
  <div class="stars" aria-hidden="true" id="stars"></div>

  <div class="wrap">
    <h1>Feliz Anivers√°rio Prof. Isabel! üéâ</h1>
    <div class="subtitle">Faz um desejo e sopra as velas ‚ú®</div>

    <section class="stage" aria-label="Bolo de anivers√°rio">
      <div class="cake" id="cake">
        <div class="candles" id="candles" aria-label="Velas">
          <!-- Velas ser√£o geradas via JS para f√°cil ajuste -->
        </div>
        <div class="tier small"><div class="drip"></div></div>
        <div class="tier"><div class="drip"></div></div>
      </div>
      <div class="plate"></div>
    </section>

    <div class="wish" id="wish">üéÇ Parab√©ns, Isabel! Que o teu ano seja doce e incr√≠vel! üíñ</div>

    <div class="controls">
      <button class="btn primary" id="btn-blow">Soprar com o microfone</button>
      <button class="btn gold" id="btn-extinguish">Apagar todas as velas</button>
      <button class="btn" id="btn-relight">Acender novamente</button>
      <button class="btn ghost" id="btn-confetti">Lan√ßar confettis</button>
      <button class="btn ghost" id="btn-music">Tocar m√∫sica üéµ</button>
    </div>

    <div class="row" style="margin-top:6px">
      <span class="badge" id="mic-status">Microfone: desligado</span>
      <span class="badge">Feito com ‚ù§Ô∏è</span>
    </div>
  </div>

  <footer> </footer>

  <script>
    // ======== Estrelas de fundo ========
    (function makeStars(){
      const cont = document.getElementById('stars');
      for(let i=0;i<80;i++){
        const s=document.createElement('i');
        s.style.left=Math.random()*100+'%';
        s.style.top=Math.random()*100+'%';
        s.style.opacity=0.3+Math.random()*0.7;
        s.style.setProperty('--t', (5+Math.random()*6)+'s');
        s.style.transform = `scale(${.5+Math.random()*1.3})`;
        cont.appendChild(s);
      }
    })();

    // ======== Construir velas ========
    const candlesEl = document.getElementById('candles');
    const NUM_CANDLES = 6; // ajusta aqui
    function buildCandles(){
      candlesEl.innerHTML = '';
      for(let i=0;i<NUM_CANDLES;i++){
        const c = document.createElement('div');
        c.className = 'candle';
        c.setAttribute('role','button');
        c.setAttribute('aria-label', 'Candle '+(i+1));
        c.innerHTML = '<div class="wick"></div><div class="flame"></div>';
        c.addEventListener('click', ()=>toggleCandle(c));
        candlesEl.appendChild(c);
      }
    }
    buildCandles();

    function toggleCandle(c){
      c.classList.toggle('out');
      checkAllOut();
    }

    function extinguishAll(){
      document.querySelectorAll('.candle').forEach(c=>c.classList.add('out'));
      checkAllOut(true);
    }

    function relightAll(){
      document.querySelectorAll('.candle').forEach(c=>c.classList.remove('out'));
      wish(false);
    }

    function checkAllOut(force){
      const allOut = [...document.querySelectorAll('.candle')].every(c=>c.classList.contains('out'));
      if(allOut || force){
        confettiBurst();
        wish(true);
      }
    }

    // ======== Mensagem de desejo ========
    const wishEl = document.getElementById('wish');
    function wish(show){
      wishEl.classList.toggle('show', !!show);
    }

    // ======== Confetti ========
    const confettiCanvas = document.getElementById('confetti');
    const ctx = confettiCanvas.getContext('2d');
    let confettiPieces = [];
    function resizeCanvas(){ confettiCanvas.width = innerWidth; confettiCanvas.height = innerHeight }
    addEventListener('resize', resizeCanvas); resizeCanvas();

    function makePiece(){
      const colors = ['#ff76c8','#ffd166','#8bd3dd','#b5e48c','#f4978e','#cdb4db','#90dbf4'];
      return {
        x: Math.random()*confettiCanvas.width,
        y: -10,
        r: 3 + Math.random()*5,
        c: colors[(Math.random()*colors.length)|0],
        vx: -2 + Math.random()*4,
        vy: 2 + Math.random()*3,
        rot: Math.random()*Math.PI,
        vr: -0.2 + Math.random()*0.4,
        shape: Math.random() < .5 ? 'circle' : 'rect'
      };
    }

    function confettiBurst(n=160){
      for(let i=0;i<n;i++) confettiPieces.push(makePiece());
      if(!animating) animate();
    }

    let animating=false;
    function animate(){
      animating=true;
      ctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
      confettiPieces = confettiPieces.filter(p => p.y < confettiCanvas.height + 12);
      for(const p of confettiPieces){
        p.x += p.vx; p.y += p.vy; p.vy += 0.03; p.rot += p.vr;
        ctx.save();
        ctx.translate(p.x, p.y); ctx.rotate(p.rot);
        ctx.fillStyle = p.c;
        if(p.shape==='circle'){ ctx.beginPath(); ctx.arc(0,0,p.r,0,Math.PI*2); ctx.fill(); }
        else { ctx.fillRect(-p.r, -p.r, p.r*2, p.r*2); }
        ctx.restore();
      }
      if(confettiPieces.length){ requestAnimationFrame(animate); }
      else animating=false;
    }

    document.getElementById('btn-confetti').addEventListener('click', ()=> confettiBurst(200));

    // ======== Microfone para soprar ========
    let micStream, analyser, dataArr, micEnabled=false;
    const micStatus = document.getElementById('mic-status');

    async function toggleMic(){
      if(micEnabled){
        stopMic();
        return;
      }
      try{
        micStream = await navigator.mediaDevices.getUserMedia({audio:true});
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const src = audioCtx.createMediaStreamSource(micStream);
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 1024; // mais sens√≠vel
        dataArr = new Uint8Array(analyser.frequencyBinCount);
        src.connect(analyser);
        micEnabled = true; micStatus.textContent = 'Microfone: a ouvir‚Ä¶ sopra para apagar!';
        document.getElementById('btn-blow').textContent = 'Parar microfone';
        listenLoudness();
      }catch(err){
        toast('N√£o foi poss√≠vel aceder ao microfone. Permiss√µes?');
      }
    }

    function stopMic(){
      if(micStream){ micStream.getTracks().forEach(t=>t.stop()); }
      micEnabled=false; analyser=null; dataArr=null;
      micStatus.textContent='Microfone: desligado';
      document.getElementById('btn-blow').textContent='Soprar com o microfone';
    }

    function listenLoudness(){
      if(!analyser || !micEnabled) return;
      analyser.getByteTimeDomainData(dataArr);
      // calcular pico simples (desvio do meio 128)
      let peak=0; for(let i=0;i<dataArr.length;i++){ const v=Math.abs(dataArr[i]-128); if(v>peak) peak=v; }
      // Threshold adapt√°vel
      if(peak > 30){ // assoprou
        extinguishAll();
      }
      requestAnimationFrame(listenLoudness);
    }

    document.getElementById('btn-blow').addEventListener('click', toggleMic);
    document.getElementById('btn-extinguish').addEventListener('click', extinguishAll);
    document.getElementById('btn-relight').addEventListener('click', relightAll);

    // ======== M√∫sica de parab√©ns (WebAudio) ========
    let musicPlaying=false, musicCtx, musicNodes=[];

    function note(freq, t, dur){
      const o = musicCtx.createOscillator();
      const g = musicCtx.createGain();
      o.type='sine'; o.frequency.setValueAtTime(freq, t);
      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(0.2, t+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
      o.connect(g).connect(musicCtx.destination);
      o.start(t); o.stop(t+dur+0.02);
      musicNodes.push(o,g);
    }

    // Escala simples para "Parab√©ns a voc√™"
    const A4=440;
    const ratios = { C:261.63, D:293.66, E:329.63, F:349.23, G:392.00, A:440.00, B:493.88, C5:523.25, D5:587.33, E5:659.26, F5:698.46, G5:783.99 };
    const song = [
      ['C',0.0,0.35], ['C',0.4,0.35], ['D',0.8,0.7], ['C',1.6,0.7], ['F',2.4,0.7], ['E',3.2,1.3],
      ['C',4.8,0.35], ['C',5.2,0.35], ['D',5.6,0.7], ['C',6.4,0.7], ['G',7.2,0.7], ['F',8.0,1.3],
      ['C',9.6,0.35], ['C',10.0,0.35], ['C5',10.4,0.7], ['A',11.2,0.7], ['F',12.0,0.7], ['E',12.8,0.7], ['D',13.6,1.3],
      ['A#',15.2,0.35], ['A#',15.6,0.35], ['A',16.0,0.7], ['F',16.8,0.7], ['G',17.6,0.7], ['F',18.4,1.3]
    ];
    // Converter A# simples para 466.16
    function freqFor(n){
      if(n==='A#') return 466.16; // rough
      return ratios[n] || 440;
    }

    async function toggleMusic(){
      if(!musicPlaying){
        musicCtx = new (window.AudioContext || window.webkitAudioContext)();
        const start = musicCtx.currentTime + 0.05;
        song.forEach(([n,dt,dur])=> note(freqFor(n), start+dt, dur));
        musicPlaying=true;
        document.getElementById('btn-music').textContent='Parar m√∫sica ‚è∏Ô∏è';
        // Parar automaticamente ap√≥s terminar (~20s)
        setTimeout(stopMusic, 20000);
      }else{
        stopMusic();
      }
    }

    function stopMusic(){
      if(!musicCtx) return;
      musicNodes.forEach(n=>{ try{ if(n.stop) n.stop(); if(n.disconnect) n.disconnect(); }catch(e){} });
      musicNodes=[];
      try{ musicCtx.close(); }catch(e){}
      musicPlaying=false; document.getElementById('btn-music').textContent='Tocar m√∫sica üéµ';
    }

    document.getElementById('btn-music').addEventListener('click', toggleMusic);

    // ======== Toast ========
    let toastEl;
    function toast(msg){
      if(!toastEl){ toastEl=document.createElement('div'); toastEl.className='toast'; document.body.appendChild(toastEl); }
      toastEl.textContent=msg; toastEl.classList.add('show');
      setTimeout(()=> toastEl.classList.remove('show'), 2200);
    }

    // Dica inicial
    setTimeout(()=> toast('Clica nas velas para apagar ‚ú®'), 800);
  </script>
</body>
</html>
