<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demoli√ß√£o da Casa do Jorge ‚Äî Grupo Armindo</title>
    <link rel="icon" href="/armindo.png">

    <!-- Premium Styles (for modal/menu consistency only, carefully scoped to not break game) -->
    <link rel="stylesheet" href="assets/css/hub-premium.css">

    <style>
        /* RESET & GAME SPECIFIC STYLES OVERRIDE */
        .game-wrapper * {
            box-sizing: border-box;
        }

        body {
            overflow: hidden;
            margin: 0;
            background: #0f1115;
            /* Match premium theme bg */
        }

        /* Overriding hub-premium body default to allow full screen game container centered */
        body.game-mode {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        /* Scoped styles for game elements to ensure no conflict with premium CSS */
        .game-canvas {
            border: 4px solid #ff6b35;
            border-radius: 12px;
            box-shadow: 0 0 50px rgba(255, 107, 53, 0.4);
            max-width: 100%;
            height: auto;
        }

        /* Nav Overlay */
        .nav-overlay {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 2000;
        }

        /* Custom Game UI */
        #scoreTimerRow {
            color: white;
            margin-bottom: 10px;
            font-family: 'Outfit', sans-serif;
        }

        #leaderboard {
            background: rgba(15, 17, 21, 0.8) !important;
            border-color: rgba(255, 255, 255, 0.1) !important;
        }

        .leaderboard-entry {
            background: rgba(255, 255, 255, 0.05) !important;
            font-family: 'Outfit', sans-serif;
        }
    </style>
</head>

<body class="game-mode">

    <!-- NAVIGATION OVERLAY -->
    <div class="nav-overlay">
        <a href="/" class="btn btn-glass btn-sm" style="background: rgba(0,0,0,0.6); backdrop-filter: blur(10px);">
            ‚Üê Voltar ao Hub
        </a>
    </div>

    <!-- MAIN MENU OVERLAY (Updated styling) -->
    <div id="mainMenu"
        style="position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:100; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);">
        <div class="glass-panel" style="text-align: center; max-width: 500px; padding: 40px;">
            <h1 class="hero-title" style="font-size: 2rem; margin-bottom: 16px; color: var(--accent-secondary);">
                Demoli√ß√£o da Casa do Jorge</h1>
            <p class="hero-desc" style="margin-bottom: 32px;">Destrua a casa o mais r√°pido poss√≠vel! Clique nas bombas
                para lan√ß√°-las.</p>

            <div style="display: flex; gap: 16px; justify-content: center;">
                <button id="playBtn" class="btn btn-primary">Jogar Agora</button>
                <button id="howBtn" class="btn btn-glass">Como Jogar</button>
            </div>

            <p style="margin-top: 24px; font-size: 0.8rem; color: var(--text-dim);">
                Top 10 jogadores aparecem no leaderboard.
            </p>
        </div>
    </div>

    <!-- GAME CONTAINER -->
    <div id="gameContainer" style="display: flex; gap: 20px; align-items: flex-start;">

        <div id="mainGame" style="display: flex; flex-direction: column; align-items: center; position: relative;">
            <div id="scoreTimerRow" style="display: flex; gap: 20px; width: 100%; justify-content: space-between;">
                <div class="badge" id="score"
                    style="background: rgba(255, 107, 53, 0.2); border-color: #ff6b35; color: #ff6b35;">
                    Pontua√ß√£o: 0
                </div>
                <div class="badge" id="timer"
                    style="background: rgba(255, 215, 0, 0.2); border-color: #ffd700; color: #ffd700;">
                    Tempo: 00:00.0
                </div>
            </div>

            <canvas id="gameCanvas" width="900" height="700" class="game-canvas"></canvas>

            <div id="health" class="badge"
                style="margin-top: 10px; background: rgba(220, 38, 38, 0.2); border-color: #ef4444; color: #ef4444;">
                Resist√™ncia da Casa: 100%
            </div>
        </div>

        <!-- SIDEBAR LEADERBOARD -->
        <div id="leaderboard" class="glass-panel"
            style="width: 300px; max-height: 80vh; overflow-y: auto; padding: 20px;">
            <h3 style="color: var(--accent-secondary); margin-bottom: 16px; text-align: center;">üèÜ Top 10</h3>
            <div class="loading" style="color: var(--text-dim); text-align: center;">Carregando...</div>
        </div>

    </div>

    <!-- GAME OVER MODAL -->
    <div id="gameOver"
        style="display:none; position:fixed; inset:0; z-index:200; align-items:center; justify-content:center; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);">
        <div class="glass-panel"
            style="text-align: center; max-width: 450px; padding: 40px; border-color: var(--accent-primary);">
            <h2 style="font-size: 2.5rem; color: var(--accent-primary); margin-bottom: 8px;">VIT√ìRIA!</h2>

            <div style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 12px; margin: 24px 0;">
                <p id="finalScore" style="color: white; font-weight: bold; margin-bottom: 8px;"></p>
                <p id="finalTime" style="color: var(--accent-secondary); font-size: 1.2rem;"></p>
            </div>

            <input type="text" id="nameInput" placeholder="Digite seu nome" maxlength="20"
                style="width: 100%; padding: 16px; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; color: white; margin-bottom: 24px; text-align: center;">

            <div style="display: flex; gap: 12px;">
                <button id="submitScore" class="btn btn-primary" style="flex: 1;">Enviar Score</button>
                <button id="playAgain" class="btn btn-glass" style="flex: 1;">Jogar Novamente</button>
            </div>
        </div>
    </div>

    <!-- ORIGINAL GAME SCRIPT ADAPTED -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, onValue, query, orderByChild, limitToLast } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyA8azNy6GEgD190y_fW91ahUbKa1w5veik",
            authDomain: "aawards.firebaseapp.com",
            databaseURL: "https://aawards-default-rtdb.firebaseio.com",
            projectId: "aawards",
            storageBucket: "aawards.firebasestorage.app",
            messagingSenderId: "839334918366",
            appId: "1:839334918366:web:454a259fa3e2665b46ea4f",
            measurementId: "G-NLLMB9THVX"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const scoresRef = ref(database, 'bombaJorge/scores');

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // Game state
        let score = 0, hits = 0, houseHealth = 100;
        let gameRunning = false;
        let bombs = [], explosions = [], clouds = [], stars = [];
        let combo = 0, comboTimer = 0;
        let startTime = null, timerInterval = null, timeElapsed = 0;

        const isMobile = (/Mobi|Android|iPhone|iPad|iPod/.test(navigator.userAgent) || navigator.maxTouchPoints > 0);
        const mobileDifficulty = isMobile ? 1.18 : 1.0;
        const CANVAS_W = 900, CANVAS_H = 700;

        for (let i = 0; i < 50; i++) stars.push({ x: Math.random() * CANVAS_W, y: Math.random() * CANVAS_H * 0.6, size: Math.random() * 2, twinkle: Math.random() * Math.PI * 2 });
        for (let i = 0; i < 5; i++) clouds.push({ x: Math.random() * CANVAS_W, y: Math.random() * 200, size: 40 + Math.random() * 40, speed: (0.3 + Math.random() * 0.5) * (isMobile ? 1.2 : 1) });

        const house = { x: CANVAS_W / 2 - 100, y: CANVAS_H - 200, width: 200, height: 150, shaking: 0 };

        class Bomb {
            constructor() {
                this.x = Math.random() * (CANVAS_W - 100) + 50;
                this.y = -30;
                this.size = 15;
                this.speed = (2 + Math.random() * 2) * mobileDifficulty;
                this.launched = false;
                this.vx = 0; this.vy = 0;
                this.clickRadius = this.size + 10 - (isMobile ? 3 : 0);
            }
            update() {
                if (!this.launched) {
                    this.y += this.speed;
                } else {
                    this.x += this.vx; this.y += this.vy; this.vy += 0.3 * mobileDifficulty;
                }
            }
            draw() {
                ctx.fillStyle = '#2a2a2a';
                ctx.beginPath(); ctx.ellipse(this.x, this.y, this.size, this.size * 1.3, 0, 0, Math.PI * 2); ctx.fill();
                ctx.strokeStyle = '#8B4513'; ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(this.x, this.y - this.size * 1.3); ctx.lineTo(this.x + 5, this.y - this.size * 1.8); ctx.stroke();
                if (!this.launched) { ctx.fillStyle = Math.random() > 0.5 ? '#ff6600' : '#ffaa00'; ctx.beginPath(); ctx.arc(this.x + 5, this.y - this.size * 1.8, 3, 0, Math.PI * 2); ctx.fill(); }
            }
            checkClick(mx, my) { const dist = Math.sqrt((mx - this.x) ** 2 + (my - this.y) ** 2); return dist < this.clickRadius; }
            checkHouseCollision() { return this.x > house.x && this.x < house.x + house.width && this.y > house.y && this.y < house.y + house.height; }
        }

        class Explosion {
            constructor(x, y, big = false) {
                this.x = x; this.y = y; this.particles = []; const count = big ? 30 : 20;
                for (let i = 0; i < count; i++) this.particles.push({ x: 0, y: 0, vx: (Math.random() - 0.5) * (big ? 12 : 8), vy: (Math.random() - 0.5) * (big ? 12 : 8), life: big ? 50 : 40, maxLife: big ? 50 : 40, size: big ? 6 : 4 });
            }
            update() { this.particles.forEach(p => { p.x += p.vx; p.y += p.vy; p.vy += 0.2; p.life--; }); this.particles = this.particles.filter(p => p.life > 0); }
            draw() { this.particles.forEach(p => { const alpha = p.life / p.maxLife; const colors = ['#ff4500', '#ff6600', '#ffaa00', '#ff8800']; ctx.fillStyle = colors[Math.floor(Math.random() * colors.length)] + Math.floor(alpha * 255).toString(16).padStart(2, '0'); ctx.beginPath(); ctx.arc(this.x + p.x, this.y + p.y, p.size, 0, Math.PI * 2); ctx.fill(); }); }
            isDone() { return this.particles.length === 0; }
        }

        function drawHouse() {
            ctx.save(); if (house.shaking > 0) { ctx.translate(Math.random() * 6 - 3, Math.random() * 6 - 3); house.shaking--; }
            const damage = 1 - (houseHealth / 100);
            ctx.fillStyle = damage > 0.5 ? '#8B4513' : '#D2691E'; ctx.fillRect(house.x, house.y + 50, house.width, 100);
            ctx.fillStyle = damage > 0.3 ? '#8B0000' : '#DC143C'; ctx.beginPath(); ctx.moveTo(house.x - 20, house.y + 50); ctx.lineTo(house.x + house.width / 2, house.y); ctx.lineTo(house.x + house.width + 20, house.y + 50); ctx.closePath(); ctx.fill();
            ctx.fillStyle = damage > 0.7 ? '#333333' : '#87CEEB'; ctx.fillRect(house.x + 30, house.y + 80, 40, 40); ctx.fillRect(house.x + 130, house.y + 80, 40, 40);
            ctx.fillStyle = '#654321'; ctx.fillRect(house.x + 80, house.y + 100, 40, 50);
            ctx.fillStyle = '#F5DEB3'; ctx.fillRect(house.x + 50, house.y - 30, 100, 25);
            ctx.fillStyle = '#000000'; ctx.font = 'bold 14px Arial'; ctx.textAlign = 'center'; ctx.fillText('Casa do Jorge', house.x + 100, house.y - 10);
            if (damage > 0.2) { ctx.strokeStyle = '#000000'; ctx.lineWidth = 2; for (let i = 0; i < damage * 10; i++) { ctx.beginPath(); const x = house.x + Math.random() * house.width; const y = house.y + 50 + Math.random() * 100; ctx.moveTo(x, y); ctx.lineTo(x + Math.random() * 20 - 10, y + Math.random() * 30); ctx.stroke(); } }
            ctx.restore();
        }

        function drawClouds() { clouds.forEach(cloud => { ctx.fillStyle = 'rgba(255,255,255,0.7)'; ctx.beginPath(); ctx.arc(cloud.x, cloud.y, cloud.size, 0, Math.PI * 2); ctx.arc(cloud.x + cloud.size * 0.6, cloud.y, cloud.size * 0.8, 0, Math.PI * 2); ctx.arc(cloud.x + cloud.size * 1.2, cloud.y, cloud.size * 0.9, 0, Math.PI * 2); ctx.fill(); cloud.x += cloud.speed; if (cloud.x > CANVAS_W + cloud.size * 2) cloud.x = -cloud.size * 2; }); }
        function drawStars() { stars.forEach(star => { star.twinkle += 0.05; const alpha = (Math.sin(star.twinkle) + 1) / 2; ctx.fillStyle = `rgba(255,255,255,${alpha * 0.8})`; ctx.beginPath(); ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2); ctx.fill(); }); }
        function drawGround() { ctx.fillStyle = '#228B22'; ctx.fillRect(0, CANVAS_H - 50, CANVAS_W, 50); for (let i = 0; i < 10; i++) { const x = (i * CANVAS_W / 10) + 20; ctx.fillStyle = ['#FF69B4', '#FFFF00', '#FF0000'][i % 3]; ctx.beginPath(); ctx.arc(x, CANVAS_H - 55, 5, 0, Math.PI * 2); ctx.fill(); } }

        function spawnBomb() { if (gameRunning && houseHealth > 0) bombs.push(new Bomb()); }

        function updateScoreUI() { document.getElementById('score').textContent = `Pontua√ß√£o: ${score} | Acertos: ${hits}`; document.getElementById('health').textContent = `Resist√™ncia da Casa: ${Math.max(0, Math.round(houseHealth))}%`; if (houseHealth <= 0) gameOver(); }

        function formatTime(ms) { const total = Math.max(0, ms); const minutes = Math.floor(total / 60000); const seconds = Math.floor((total % 60000) / 1000); const tenths = Math.floor((total % 1000) / 100); return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${tenths}`; }

        function startTimer() { startTime = Date.now(); timeElapsed = 0; document.getElementById('timer').textContent = `Tempo: 00:00.0`; if (timerInterval) clearInterval(timerInterval); timerInterval = setInterval(() => { timeElapsed = Date.now() - startTime; document.getElementById('timer').textContent = `Tempo: ${formatTime(timeElapsed)}`; }, 100); }
        function stopTimer() { if (timerInterval) clearInterval(timerInterval); }

        function gameOver() {
            gameRunning = false; stopTimer(); const finalTime = timeElapsed;
            document.getElementById('finalScore').textContent = `Casa Destru√≠da! Score: ${score} | Acertos: ${hits}`;
            document.getElementById('finalTime').textContent = `Seu tempo: ${formatTime(finalTime)}`;

            const gameOverModal = document.getElementById('gameOver');
            gameOverModal.style.display = 'flex'; // Use flex to center with our new styling

            document.getElementById('nameInput').value = '';
            document.getElementById('submitScore').disabled = false;
            window._lastRun = { score, hits, timeTaken: finalTime };
        }

        function resetState() { score = 0; hits = 0; houseHealth = 100; gameRunning = false; bombs = []; explosions = []; combo = 0; comboTimer = 0; house.shaking = 0; updateScoreUI(); document.getElementById('gameOver').style.display = 'none'; }

        function startGame() {
            resetState(); gameRunning = true; document.getElementById('mainMenu').style.display = 'none'; startTimer();
            spawnInterval = setInterval(spawnBomb, isMobile ? 1000 : 1200);
            if (!window._gameLoopRunning) { window._gameLoopRunning = true; gameLoop(); }
        }

        window.submitScore = async function () { const nameInput = document.getElementById('nameInput'); const playerName = nameInput.value.trim(); if (!playerName) { alert('Por favor, digite seu nome!'); return; } document.getElementById('submitScore').disabled = true; try { const payload = { name: playerName, score: score, hits: hits, timeTaken: (window._lastRun?.timeTaken ?? timeElapsed), timestamp: Date.now() }; await push(scoresRef, payload); alert('Pontua√ß√£o enviada com sucesso!'); nameInput.value = ''; } catch (e) { console.error('Error', e); alert('Erro ao enviar pontua√ß√£o.'); document.getElementById('submitScore').disabled = false; } }

        function gameLoop() {
            const gradient = ctx.createLinearGradient(0, 0, 0, CANVAS_H);
            gradient.addColorStop(0, '#4A90E2'); gradient.addColorStop(0.5, '#87CEEB'); gradient.addColorStop(0.6, '#87CEEB'); gradient.addColorStop(0.6, '#90EE90'); gradient.addColorStop(1, '#228B22');
            ctx.fillStyle = gradient; ctx.fillRect(0, 0, CANVAS_W, CANVAS_H);
            drawStars(); drawClouds(); drawGround(); drawHouse(); drawCombo();

            bombs.forEach((bomb, index) => {
                bomb.update(); bomb.draw();
                if (bomb.launched && bomb.checkHouseCollision()) {
                    explosions.push(new Explosion(bomb.x, bomb.y, true)); bombs.splice(index, 1);
                    houseHealth -= 10; hits++; const bonusPoints = combo > 1 ? 20 * combo : 20; score += bonusPoints; house.shaking = 15; updateScoreUI();
                    for (let i = 0; i < 3; i++) { setTimeout(() => { explosions.push(new Explosion(bomb.x + (Math.random() - 0.5) * 40, bomb.y + (Math.random() - 0.5) * 40, false)); }, i * 100); }
                } else if (bomb.y > CANVAS_H + 50) { bombs.splice(index, 1); }
            });

            explosions.forEach((explosion, index) => { explosion.update(); explosion.draw(); if (explosion.isDone()) explosions.splice(index, 1); });

            if (gameRunning) requestAnimationFrame(gameLoop);
            else window._gameLoopRunning = false;
        }

        function drawCombo() { if (comboTimer > 0) { comboTimer--; const scale = 1 + (Math.sin(Date.now() * 0.01) * 0.1); ctx.save(); ctx.translate(CANVAS_W / 2, 80); ctx.scale(scale, scale); ctx.font = 'bold 48px Arial'; ctx.fillStyle = '#FFD700'; ctx.strokeStyle = '#FF6B35'; ctx.lineWidth = 4; ctx.textAlign = 'center'; ctx.strokeText(`COMBO x${combo}!`, 0, 0); ctx.fillText(`COMBO x${combo}!`, 0, 0); ctx.restore(); } else { combo = 0; } }

        document.getElementById('playBtn').addEventListener('click', startGame);
        document.getElementById('howBtn').addEventListener('click', () => alert('Clique ou toque nas bombas para lan√ß√°-las √† casa.'));
        document.getElementById('playAgain').addEventListener('click', () => { document.getElementById('gameOver').style.display = 'none'; startGame(); });
        document.getElementById('submitScore').addEventListener('click', window.submitScore);

        // Leaderboard
        const leaderboardQuery = query(scoresRef, limitToLast(200));
        onValue(leaderboardQuery, (snapshot) => {
            const leaderboardDiv = document.getElementById('leaderboard');
            const scoresArr = [];
            snapshot.forEach(child => scoresArr.push({ id: child.key, ...child.val() }));
            const valid = scoresArr.filter(s => s.timeTaken !== undefined);
            valid.sort((a, b) => a.timeTaken - b.timeTaken);
            const top10 = valid.slice(0, 10);
            let html = '<h3 style="color: var(--accent-secondary); margin-bottom: 16px; text-align: center;">üèÜ Top 10</h3>';
            if (top10.length === 0) html += '<div class="loading">Nenhuma marca registrada ainda.</div>';
            else {
                top10.forEach((entry, idx) => {
                    html += `
                        <div class="leaderboard-entry" style="display:flex; justify-content:space-between; padding:8px; margin-bottom:4px; border-radius:4px; font-size: 0.9rem;">
                           <span>#${idx + 1} ${entry.name}</span>
                           <span style="color:#ffd700;">${formatTime(entry.timeTaken)}</span>
                        </div>`;
                });
            }
            leaderboardDiv.innerHTML = html;
        });

        setInterval(() => { if (!gameRunning && Math.random() < 0.3) spawnBomb(); }, 2500);

    </script>
</body>

</html>